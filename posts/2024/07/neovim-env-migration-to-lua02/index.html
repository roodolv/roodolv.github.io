<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta property="og:type" content="article"><meta property="og:url" content="https://roodolv.dev/posts/2024/07/neovim-env-migration-to-lua02/"><meta property="og:image" content="https://roodolv.dev/img/favicon.png"><meta property="og:title" content="NeovimをLua環境に移行する 第2回 - dolvlog"><meta property="og:site_name" content="dolvlog"><meta property="og:description" content><meta name=twitter:card content="summary"><meta name=twitter:image content="img/favicon.png"><meta name=twitter:title content="NeovimをLua環境に移行する 第2回 - dolvlog"><meta name=twitter:creator content="@roodolv"><meta name=generator content="Hugo 0.111.3"><title>NeovimをLua環境に移行する 第2回 - dolvlog</title><meta name=description content="NeovimのLua移行記事リンク 第1回 第2回(今回) 要約 今回はLua移行作業全体についてざっくりと振り返る
特にプラグイン導入作業中の失敗から得られた教訓を先に示しておく
数字で振り返るLua環境移行 別に「これだけやったんだぞ！」ということが言いたい訳ではないのだが、とりあえず作業工程全..."><link rel="shortcut icon" href=img/favicon.png><link rel=stylesheet href=/css/ui.css><link rel=stylesheet href=/css/custom.css><link rel=stylesheet href=/css/fonts.css><script defer src=/js/dark-mode.js></script>
<link disabled id=dark-mode-theme rel=stylesheet href=/css/dark.css><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Fira+Mono|Lato|Raleway"></head><body><header class="container no-print"><div class=u-header><nav class=bar><ul><li><a href=/><img class=icon-text src=/img/prev.svg></a></li><li><img class=icon-text id=dark-mode-toggle src=/img/moon-regular.svg alt="Toggle Dark Mode"></a></li><li><a href=/about>About</a></li><li><a href=/posts/>Posts</a></li><li><a href=/tags/>Tags</a></li></ul></nav></div></header><main class=container><article><header><hgroup id=brand><h1>NeovimをLua環境に移行する 第2回</h1><h5><time datetime="2024-07-20 00:22:45 +0900 +0900">2024-07-20</time>
<span class="no-print post-header">-
<a href=/tags/neovim>#neovim</a>
<a href=/tags/neovim-plugins>#neovim-plugins</a>
<a href=/tags/lua>#lua</a>
<span></h5></hgroup><hr class=sep></header><h4 id=neovimのlua移行記事リンク>NeovimのLua移行記事リンク</h4><ul><li><a href=/posts/2024/07/neovim-env-migration-to-lua01>第1回</a></li><li>第2回(今回)</li></ul><h3 id=要約>要約</h3><p>今回はLua移行作業全体についてざっくりと振り返る</p><p>特にプラグイン導入作業中の失敗から得られた教訓を先に示しておく</p><h3 id=数字で振り返るlua環境移行>数字で振り返るLua環境移行</h3><p>別に「これだけやったんだぞ！」ということが言いたい訳ではないのだが、とりあえず作業工程全体のイメージが掴みやすいと思うので数字で表してみる</p><ul><li>かかった期間は<strong>約1か月ほど</strong></li><li>調査あるいは精査したVim/Neovimプラグインの総数は<strong>200個</strong>超</li><li>導入したプラグイン数(自作プラグインは除外)<ul><li>lazy.nvim上で<strong>96個</strong></li><li><a href=https://dotfyle.com>Dotfyle</a>の<a href=https://dotfyle.com/roodolv>ユーザーページ</a>で<strong>61個</strong></li></ul></li><li><code>init.lua</code>の行数は<strong>3976行</strong> (2024年7月19日現在)</li><li>作業ログ(Markdown)は<strong>15000行以上</strong></li></ul><p>主にプラグインを全面的に見直したせいなのだが、作業が特別早い人でもそこそこ時間のかかる物量だったのではないかと個人的に思う</p><p>(ただ総作業時間の半分程度はプラグインの調査にかかった時間だった気がする……)</p><h3 id=プラグイン導入時の反省と教訓>プラグイン導入時の反省と教訓</h3><p>今回Neovimに大量のプラグインを導入してみた訳だが、後から振り返った時「こうしておけばもっとスムーズに出来たな」と感じる部分があった</p><p>そこから得られた教訓を幾つかまとめておこうと思う</p><h4 id=1-luaの補完フォーマット環境を早い段階でつくる>1. Luaの補完・フォーマット環境を早い段階でつくる</h4><p>自分の場合、現在Luaに関しては下記のような環境となっている</p><ul><li>Language Server: <strong>lua-ls</strong> (lua-language-server)</li><li>パース補助: <a href=https://github.com/folke/neodev.nvim>neodev.nvim</a></li><li>補完: <a href=https://github.com/hrsh7th/nvim-cmp>nvim-cmp</a></li><li>フォーマッタ: <strong>stylua</strong></li><li>フォーマット設定: <a href=https://github.com/stevearc/conform.nvim>conform.nvim</a></li></ul><p>まず必須であるLua用のLanguage Serverに関しては、自分は<strong>lua-ls</strong>を<a href=https://scoop.sh>Scoop</a>で管理している</p><p>次に<strong>Neovim API用のパース</strong>を行ってくれる<a href=https://github.com/folke/neodev.nvim>neodev.nvim</a> <sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup>だが、これはもっと早くに導入すべきだった</p><p>これがあるかどうかで視認性や可読性やエラーチェックの挙動など諸々の快適さが変わるため、今後Lua移行を行う方は是非早い段階で入れておくことをおすすめする</p><p>また、設定ファイルとしてLuaを書く時は<strong>Neovim API</strong>を頻繁に呼び出すことになるが、未知のモジュール・関数も候補に表示できるようになるので補完プラグインも早めに入れた方が良い</p><p>そして言うまでもなく、フォーマッタがあれば<code>function</code>やLuaのテーブル型データなどの記述に便利なので、やはりこれも早い段階で入れておくことをおすすめする</p><h4 id=2-プラグインの最適化は後に回す>2. プラグインの最適化は後に回す</h4><p>当たり前のことだが、一応書いておく</p><p>例えば依存関係の多いプラグインなどの設定を詰めた後で、その代替プラグインが見つかったとする</p><p>そうなると、既に導入した依存先のプラグイン設定ごと引っ越す……つまり設定をやり直す羽目になる</p><p>当然だが既に使った時間やエネルギーは全て無駄になってしまう訳なので、 <strong>プラグイン毎の最適化は使うプラグインの選定が完全に終わってから</strong> にすべき……という話だ</p><p>自分の場合で言えば、<a href=https://github.com/nvimtools/none-ls.nvim>none-ls.nvim</a>(null-ls.nvimの後継)関連の設定にそれなりに時間を使ったのだが、後でその代替として<a href=https://github.com/stevearc/conform.nvim>conform.nvim</a>を採用することになり、時間をロスしてしまった</p><p>これが結構なロスになるので、一度自分の環境に入れて、手に馴染ませたうえで「これはずっと使うし、自分にとってはこれ以上の競合もないな」と確認できてからconfigを詰める方が理想的だ <sup id=fnref:2><a href=#fn:2 class=footnote-ref role=doc-noteref>2</a></sup></p><h4 id=3-パッケージをmason依存にするかどうか先に決める>3. パッケージをMason依存にするかどうか先に決める</h4><p>これも段取りに関する反省という意味では2.と似ているのだが……</p><p>LSP関連やフォーマッターなどのパッケージをインストール・管理する際に <strong>Masonを利用するかどうか</strong> は先に決めておいた方が時間のロスは少なくなる</p><p>Masonを利用したパッケージ管理といえば大体は</p><ul><li><a href=https://github.com/williamboman/mason.nvim>mason.nvim</a></li><li><a href=https://github.com/williamboman/mason-lspconfig.nvim>mason-lspconfig.nvim</a></li></ul><p>などを利用するのが一般的だと思われるが、やはりローカルで完結させたい自分としては少しMason依存に抵抗があり、後で変更することになった</p><p>最初から決めておけばそれなりに時間が節約できたかなと思う</p><h4 id=4-バッファ間バッファ内を高速移動できるようにしておく>4. バッファ間＆バッファ内を高速移動できるようにしておく</h4><p>これも、Vimmerに対しては言うまでもないことで恐縮なのだが……</p><p>まず<strong>Vimの設計思想</strong>を最低限理解し、<strong>バッファ間/バッファ内移動</strong>の効率を高めておいた方がプラグイン導入時・環境移行時の無駄は少なくなる</p><p>というのも、移行作業時は頻繁にバッファ間やバッファ内を移動する羽目になるからだ</p><p>個人的には、Neovimにおいて効率的な移動を実現するためには<strong>2つの手段</strong>を組み合わせるのが効果的だと思う</p><ol><li>Vim本体の機能: Marks、Jumplist、QuickFix、LocList etc</li><li><strong>強力</strong>なNeovimプラグイン: telescope.nvim、harpoon、flash.nvim、nvim-navbuddy etc</li></ol><p>これらを組み合わせることで、例えば以下のような<strong>非効率な操作・状態</strong>を極力避けることが出来る</p><ul><li>バッファ内で移動したい行・シンボルへすぐに移動できない</li><li>大量にタブを開き、タブ切り替えコマンドを連打しながら作業する</li><li>複数のタブで同じルートディレクトリのファイルを開き、往復する</li><li>一度しか開かないファイルと頻繁に開くファイルが整理できていない</li><li>任意のルートディレクトリにすぐに移動できない</li></ul><p>更にここで具体的な方法を解説したいところだが、特にこの項目については自分のこだわり＆オススメ設定もあるので続きの記事で詳しく解説させてもらいたいと思う(すみませんまだ書いてないだけです……)</p><h4 id=5-キーマップ設定の方針思想を先に定める>5. キーマップ設定の方針・思想を先に定める</h4><p>自分は予め行っていたのだが、一応書いておく</p><p>大量のプラグインを導入するにあたり、<strong>キーマップ設定が衝突しないよう</strong>予め方針や軸を定めておくことが重要だと思う</p><p>これをしておかないと、「とりあえず」で暫定的なキーマップを次から次へと導入しては設定しなおす、という手戻り<sup id=fnref:3><a href=#fn:3 class=footnote-ref role=doc-noteref>3</a></sup>が発生する為だ</p><p>ざっくりになるが、例えば自分は下記のような方針を先に決めた上でプラグイン追加をしていった</p><ul><li><code>&lt;Leader></code>から始まるキーマップは殆どユーザープラグインの(Vim本体のものではない)機能に割り当てる</li><li>モディファイアキー(<code>Ctrl</code>や<code>Alt</code>)を含むキーマップは主にバッファ、ウィンドウ、タブ、QuickFix関連操作に割り当てる</li><li>複数ストロークでも大半は3ストロークまでに収める</li><li><code>g</code>/<code>z</code>から始まるキーマップは慎重に決める</li></ul><p>これに関しても後の記事で詳しく書くかも知れない</p><h3 id=おわりに>おわりに</h3><p>今回はここまで</p><p>次回は<strong>バッファ間・バッファ内の高速移動</strong>に関する設定例や、それを実現する為のおすすめプラグインについて書いていく</p><div class=footnotes role=doc-endnotes><hr><ol><li id=fn:1><p>2024年7月19日現在、Neovim0.10.0以上のユーザーに対して<a href=https://github.com/folke/neodev.nvim>neodev.nvim</a>は非推奨(deprecated)となり、<a href=https://github.com/folke/lazydev.nvim>lazydev.nvim</a>が代わりに推奨されているので注意&#160;<a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:2><p>とは言ってもそう簡単に行かない(＝後から魅力あるプラグインがどんどん見つかる)のがNeovim沼なのだが……&#160;<a href=#fnref:2 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:3><p>厳密には建築業界の用語らしいが敢えて使わせていただく&#160;<a href=#fnref:3 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></div></article><hr><nav class="no-print post-nav"><div class=prev-post><a href=https://roodolv.dev/posts/2024/07/neovim-env-migration-to-lua01/><img class=icon-text src=/img/prev.svg>NeovimをLua環境に移行する 第1回</a></div><div class=next-post></div></nav><script src=https://utteranc.es/client.js repo issue-term=url label theme=github-light crossorigin=anonymous async></script><div id=disqus_thread class=no-print></div><script type=text/javascript>(function(){if(window.location.hostname=="localhost")return;var t,e=document.createElement("script");e.type="text/javascript",e.async=!0,t="",e.src="//"+t+".disqus.com/embed.js",(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(e)})()</script><noscript>Please enable JavaScript to view the <a href=http://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><hr class=sep></main><footer class="container no-print"><div class=u-footer><a href=mailto:roodolv0x00@gmail.com><img class=icon-social src=/img/email.svg alt="Email Me!"></a>
<a href=https://github.com/roodolv/><img class=icon-social src=/img/github.svg alt=Github></a>
<a href=https://twitter.com/roodolv><img class=icon-social src=/img/twitter.svg alt=Twitter></a>
<a href=https://bsky.app/profile/roodolv.bsky.social><img class=icon-social src=/img/bluesky.svg alt=Bluesky></a>
<a href=https://roodolv.dev/index.xml target=_blank><img class=icon-social src=/img/feed.svg alt=Feed></a><p>&copy; 2023-2024
roodolv
| <a href=/license>License</a></p><a href=#brand><img class=icon-text src=/img/toup.svg alt="To Up">
<span>Back to Up</span></a></div></footer><link rel=stylesheet href=//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/hybrid.min.css><script src=//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js></script>
<script src=//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/go.min.js></script>
<script src=/js/code-block-wrapper.js></script>
<script src=/js/code-lang-name.js></script>
<script src=/js/code-row-number.js></script>
<script>hljs.highlightAll()</script><script src=https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js></script>
<script src=https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js></script>
<script src=/js/code-copy-button.js></script></body></html>